<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downstream</title>
    <!-- Tailwind CSS para design minimalista -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Plugin para adicionar labels aos gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Biblioteca para exportar para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Estilos personalizados para os gráficos */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-bottom: 3rem; /* Aumenta a margem para um melhor espaçamento */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        /* Estiliza a scrollbar para um visual mais limpo */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .export-button {
            background-color: transparent;
            color: #4B5563; /* Cor do texto cinza escuro */
            border: 1px solid #D1D5DB; /* Borda cinza */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            transition: all 0.2s ease-in-out;
        }
        .export-button:hover {
            background-color: #F3F4F6; /* Cor de fundo cinza claro no hover */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="container mx-auto max-w-7xl">
        <!-- Título e Subtítulo -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Downstream</h1>
            <p class="text-lg md:text-xl text-gray-600 mt-2">Análise e Gestão da Downstream (25/08/2025 - 29/08/2025)</p>
        </header>

        <main class="space-y-8">
            <!-- Main View - Painel de controle e gráficos -->
            <div id="main-view">
                <!-- Seção de Adicionar Item -->
                <section class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Adicionar Novo Item</h2>
                    <form id="item-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Item</label>
                            <input type="text" id="item-name" placeholder="Ex: Criar página de login" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="item-tags" class="block text-sm font-medium text-gray-700 mb-1">Tags (separar por vírgula)</label>
                            <input type="text" id="item-tags" placeholder="Ex: frontend, bug" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="item-status" class="block text-sm font-medium text-gray-700 mb-1">Status Inicial</label>
                            <select id="item-status" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="To Do">To Do</option>
                                <option value="In Progress">Em Progresso</option>
                                <option value="Review">Em Revisão</option>
                                <option value="Done">Concluído</option>
                                <option value="Produção">Produção</option>
                                <option value="Pronto pra produção">Pronto pra produção</option>
                                <option value="Teste cruzado">Teste cruzado</option>
                                <option value="Desenvolvimento">Desenvolvimento</option>
                                <option value="Refinamento">Refinamento</option>
                            </select>
                        </div>
                         <div id="deploy-type-container">
                            <label for="deploy-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Deploy</label>
                            <select id="deploy-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="sem deploy">sem deploy</option>
                                <option value="release">release</option>
                                <option value="hotfix">hotfix</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-2 lg:col-span-4 flex justify-between items-center gap-2">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Adicionar Item
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Seção Downstream -->
                <section class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Downstream</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="sprint-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ação</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="sprint-table-body">
                                <!-- Os itens serão renderizados aqui via JavaScript -->
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum item adicionado ainda.</td>
                                </tr>
                            </tbody>
                            <tfoot id="table-footer">
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center">
                                        <button onclick="changeView('fullList')" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">
                                            Ver todos os itens
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>

                <!-- Seção de Gráficos e Exportação -->
                <section class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Análise da Downstream</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Gráfico 1: Burndown Chart -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Burndown Chart</h3>
                                    <button onclick="exportChartToPdf('burndown-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Mostra a quantidade de trabalho restante ao longo do tempo. Ajuda a prever se o time terminará a sprint no prazo.</p>
                            </div>
                            <canvas id="burndown-chart"></canvas>
                        </div>
                        <!-- Gráfico 2: Cycle Time -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Cycle Time (Tempo de Conclusão)</h3>
                                    <button onclick="exportChartToPdf('cycle-time-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Mede o tempo médio que os itens levam para passar do status "Em Progresso" para "Concluído".</p>
                            </div>
                            <canvas id="cycle-time-chart"></canvas>
                        </div>
                        <!-- Gráfico 3: Distribuição por Status -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Itens por Status</h3>
                                    <button onclick="exportChartToPdf('status-distribution-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Apresenta a quantidade de itens em cada status, dando uma visão geral do fluxo de trabalho.</p>
                            </div>
                            <canvas id="status-distribution-chart"></canvas>
                        </div>
                        <!-- Novo Gráfico: Itens por Tipo -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Itens por Tipo (Bug, Task, Feature)</h3>
                                    <button onclick="exportChartToPdf('item-type-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Compara a quantidade de bugs, tarefas (tasks) e funcionalidades (features) na sprint.</p>
                            </div>
                            <canvas id="item-type-chart"></canvas>
                        </div>
                        <!-- Novo Gráfico: Status por Tipo -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Status por Tipo</h3>
                                    <button onclick="exportChartToPdf('status-by-type-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Mostra a distribuição de bugs, tasks e features em cada status do ciclo de vida.</p>
                            </div>
                            <canvas id="status-by-type-chart"></canvas>
                        </div>
                        <!-- Novo Gráfico: Quantidade Total de Itens -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Quantidade Total de Itens</h3>
                                    <button onclick="exportChartToPdf('total-items-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Acompanha a contagem total de itens criados na sprint ao longo do tempo.</p>
                            </div>
                            <canvas id="total-items-chart"></canvas>
                        </div>
                        <!-- Novo Gráfico: Tipos de Deploy em Produção -->
                        <div class="chart-container">
                            <div class="flex flex-col mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium text-gray-800">Tipos de Deploy em Produção</h3>
                                    <button onclick="exportChartToPdf('deploy-type-chart')" class="export-button">
                                        Exportar PDF
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Distribuição de itens em status de Produção por tipo de deploy.</p>
                            </div>
                            <canvas id="deploy-type-chart"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- Novo botão para a apresentação -->
                <div class="flex justify-center mt-8">
                    <a href="apresentacao-downstream.html" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">
                        Ver Apresentação
                    </a>
                </div>

            </div>

            <!-- Full List View - Visualização completa de itens por semana -->
            <div id="full-list-view" style="display: none;">
                <section class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Todos os Itens do Downstream</h2>
                        <button onclick="changeView('main')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Voltar
                        </button>
                    </div>
                    <div id="full-list-container" class="space-y-6">
                        <!-- Conteúdo dinâmico será injetado aqui -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para exibir a lista de itens de deploy -->
    <div id="deploy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <ul id="modal-list" class="space-y-2 text-sm text-gray-600 max-h-80 overflow-y-auto">
                <!-- Lista de itens será inserida aqui -->
            </ul>
        </div>
    </div>

    <script>
        // Data model and state management
        // Dados pré-carregados com base na sua solicitação
        let sprintItems = [
            { id: crypto.randomUUID(), name: 'Retirar 2 resultados de NPS erroneos', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T10:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Bug na sincronização de telefones da meta', tags: ['bug'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T11:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Mensagens de disparos para clientes inadimplentes', tags: ['bug'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T12:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Instabilidade PA', tags: ['bug'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T13:00:00Z') }], deployType: 'sem deploy' },
            { id: crypto.randomUUID(), name: 'Remover envios testes', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T14:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Atualizar a data do pós atendimentotask', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T15:00:00Z') }], deployType: 'sem deploy' },
            { id: crypto.randomUUID(), name: 'Conflito no envio da mensagembug', tags: ['bug'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T16:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Erro no analisador de chamados', tags: ['bug'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-25T17:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Criar opção de selecionar campo de contato no integrador do Voalle', tags: ['feature'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T09:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Configuração do domíniotask', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T10:00:00Z') }], deployType: 'release' },
            { id: crypto.randomUUID(), name: 'Alterar tempo de envio', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T11:00:00Z') }], deployType: 'sem deploy' },
            { id: crypto.randomUUID(), name: 'Alterar tempo de envio NPStask', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T12:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Ajuste da pergunta de resolutividadetask', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T13:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Adicionar coringa para o número do leadtask', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T14:00:00Z') }], deployType: 'hotfix' },
            { id: crypto.randomUUID(), name: 'Planilha de não enviadastask', tags: ['task'], status: 'Produção', statusHistory: [{ status: 'Produção', timestamp: new Date('2025-08-26T15:00:00Z') }], deployType: 'release' },
            { id: crypto.randomUUID(), name: 'Problema no menu de envio do PAbug', tags: ['bug'], status: 'Pronto pra produção', statusHistory: [{ status: 'Pronto pra produção', timestamp: new Date('2025-08-27T09:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'BUG- Ajuste nos modelos de resposta automática da Metabug', tags: ['bug'], status: 'Teste cruzado', statusHistory: [{ status: 'Teste cruzado', timestamp: new Date('2025-08-27T10:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Inserir script da ferramenta de pop-up na plataforma', tags: ['task'], status: 'Teste cruzado', statusHistory: [{ status: 'Teste cruzado', timestamp: new Date('2025-08-27T11:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Adicionar botão de verificar númerotask', tags: ['task'], status: 'Teste cruzado', statusHistory: [{ status: 'Teste cruzado', timestamp: new Date('2025-08-27T12:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Landing page - Tela simples de Convite com Formulário', tags: ['feature'], status: 'Desenvolvimento', statusHistory: [{ status: 'Desenvolvimento', timestamp: new Date('2025-08-27T13:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Landing Page Segmentada com Múltiplas Etapas', tags: ['feature'], status: 'Desenvolvimento', statusHistory: [{ status: 'Desenvolvimento', timestamp: new Date('2025-08-27T14:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'envio NPSTask', tags: ['task'], status: 'Refinamento', statusHistory: [{ status: 'Refinamento', timestamp: new Date('2025-08-28T09:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Edição de nota para pesquisa sem resolutividadetask', tags: ['task'], status: 'Refinamento', statusHistory: [{ status: 'Refinamento', timestamp: new Date('2025-08-28T10:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Relatórios de pesquisas personalizadasTask', tags: ['task'], status: 'Refinamento', statusHistory: [{ status: 'Refinamento', timestamp: new Date('2025-08-28T11:00:00Z') }] },
            { id: crypto.randomUUID(), name: 'Ativar conexa no Zapisptask', tags: ['task'], status: 'Refinamento', statusHistory: [{ status: 'Refinamento', timestamp: new Date('2025-08-28T12:00:00Z') }] }
        ];

        let currentView = 'main'; // 'main' or 'fullList'
        let burndownChartInstance;
        let cycleTimeChartInstance;
        let statusDistributionChartInstance;
        let itemTypeChartInstance;
        let statusByTypeChartInstance;
        let totalItemsChartInstance;
        let deployTypeChartInstance;

        // Register the datalabels plugin
        Chart.register(ChartDataLabels);

        // Function to load data from localStorage
        function loadData() {
            const data = localStorage.getItem('sprintData');
            if (data) {
                sprintItems = JSON.parse(data);
                sprintItems.forEach(item => {
                    item.statusHistory.forEach(history => {
                        history.timestamp = new Date(history.timestamp);
                    });
                });
            }
        }

        // Function to save data to localStorage
        function saveData() {
            localStorage.setItem('sprintData', JSON.stringify(sprintItems));
        }
        
        // Exibe ou esconde o seletor de tipo de deploy
        document.getElementById('item-status').addEventListener('change', function() {
            const deployTypeContainer = document.getElementById('deploy-type-container');
            if (this.value === 'Produção') {
                deployTypeContainer.style.display = 'block';
            } else {
                deployTypeContainer.style.display = 'none';
            }
        });

        // Function to add a new sprint item
        function addItem(name, tags, status, deployType) {
            const newItem = {
                id: crypto.randomUUID(),
                name: name,
                tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                status: status,
                statusHistory: [{ status: status, timestamp: new Date() }],
                deployType: status === 'Produção' ? deployType : undefined
            };
            sprintItems.push(newItem);
            saveData();
            renderUI();
        }

        // Function to change the status of an item
        function changeStatus(itemId, newStatus) {
            const item = sprintItems.find(i => i.id === itemId);
            if (item && item.status !== newStatus) {
                item.status = newStatus;
                item.statusHistory.push({ status: newStatus, timestamp: new Date() });
                saveData();
                renderUI();
            }
        }

        // Função para mudar a visualização entre painel principal e lista completa
        function changeView(view) {
            currentView = view;
            const mainView = document.getElementById('main-view');
            const fullListView = document.getElementById('full-list-view');
            
            if (currentView === 'main') {
                mainView.style.display = 'block';
                fullListView.style.display = 'none';
                renderUI(); // Re-renderizar o painel principal
            } else {
                mainView.style.display = 'none';
                fullListView.style.display = 'block';
                renderFullList(); // Renderizar a lista completa
            }
        }

        // Function to calculate and render the Burndown Chart
        function createBurndownChart() {
            if (burndownChartInstance) {
                burndownChartInstance.destroy();
            }

            const initialTotalItems = sprintItems.length;
            if (initialTotalItems === 0) {
                document.getElementById('burndown-chart').getContext('2d').clearRect(0, 0, 1, 1);
                return;
            }

            const startDate = new Date('2025-08-25');
            const endDate = new Date('2025-08-29');
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            const labels = [];
            const remainingData = [];

            for (let i = 0; i <= daysDiff; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                labels.push(currentDate.toLocaleDateString('pt-BR'));
                
                let remainingItems = 0;
                sprintItems.forEach(item => {
                    const lastStatusEntry = item.statusHistory.findLast(history => history.timestamp <= currentDate);
                    if (lastStatusEntry && lastStatusEntry.status !== 'Done') {
                        remainingItems++;
                    }
                });
                remainingData.push(remainingItems);
            }
            
            const ctx = document.getElementById('burndown-chart').getContext('2d');
            burndownChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Itens Restantes',
                            data: remainingData,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0.3,
                            datalabels: {
                                color: 'rgba(59, 130, 246, 1)',
                                align: 'end',
                                anchor: 'end'
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Itens'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Dia: ${tooltipItems[0].label}`;
                                },
                                label: function(tooltipItem) {
                                    return `Itens restantes: ${tooltipItem.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to calculate and render the Cycle Time Chart
        function createCycleTimeChart() {
            if (cycleTimeChartInstance) {
                cycleTimeChartInstance.destroy();
            }

            const doneItems = sprintItems.filter(item => item.status === 'Done');
            if (doneItems.length === 0) {
                 document.getElementById('cycle-time-chart').getContext('2d').clearRect(0, 0, 1, 1);
                return;
            }

            const labels = doneItems.map(item => item.name);
            const data = doneItems.map(item => {
                const startTimeEntry = item.statusHistory.find(h => h.status === 'In Progress');
                const doneTimeEntry = item.statusHistory.findLast(h => h.status === 'Done');

                if (startTimeEntry && doneTimeEntry) {
                    const durationInMinutes = (doneTimeEntry.timestamp - startTimeEntry.timestamp) / (1000 * 60);
                    return durationInMinutes.toFixed(2);
                }
                return 0; // Return 0 if data is incomplete
            });

            const ctx = document.getElementById('cycle-time-chart').getContext('2d');
            cycleTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tempo de Conclusão (minutos)',
                        data: data,
                        backgroundColor: 'rgba(52, 211, 153, 0.8)',
                        borderColor: 'rgba(52, 211, 153, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                        datalabels: {
                            color: 'rgba(52, 211, 153, 1)',
                            anchor: 'end',
                            align: 'end'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tempo (minutos)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Item: ${tooltipItems[0].label}`;
                                },
                                label: function(tooltipItem) {
                                    return `Tempo de conclusão: ${tooltipItem.parsed.y} minutos`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to calculate and render the Status Distribution Chart
        function createStatusDistributionChart() {
            if (statusDistributionChartInstance) {
                statusDistributionChartInstance.destroy();
            }
            
            const statusCounts = sprintItems.reduce((acc, item) => {
                acc[item.status] = (acc[item.status] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            
            const backgroundColors = labels.map(status => {
                switch(status) {
                    case 'To Do': return '#60A5FA'; // blue
                    case 'In Progress': return '#FACC15'; // yellow
                    case 'Review': return '#A78BFA'; // purple
                    case 'Done': return '#4ADE80'; // green
                    case 'Produção': return '#A5B4FC'; // light purple
                    case 'Pronto pra produção': return '#FCA5A5'; // light red
                    case 'Teste cruzado': return '#6EE7B7'; // mint green
                    case 'Desenvolvimento': return '#FDBA74'; // orange
                    case 'Refinamento': return '#E5E7EB'; // light gray
                    default: return '#D1D5DB';
                }
            });

            const ctx = document.getElementById('status-distribution-chart').getContext('2d');
            statusDistributionChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Itens',
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4,
                        datalabels: {
                            color: '#fff',
                            formatter: (value, ctx) => {
                                const total = ctx.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                const percentage = ((value / total) * 100).toFixed(0);
                                return `${value} (${percentage}%)`;
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(2);
                                    label += ` (${percentage}%)`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to create the Items by Type Chart
        function createItemTypeChart() {
            if (itemTypeChartInstance) {
                itemTypeChartInstance.destroy();
            }

            const typeCounts = {
                'bug': 0,
                'task': 0,
                'feature': 0
            };
            sprintItems.forEach(item => {
                if (item.tags.includes('bug')) typeCounts['bug']++;
                if (item.tags.includes('task')) typeCounts['task']++;
                if (item.tags.includes('feature')) typeCounts['feature']++;
            });
            
            const labels = ['Bugs', 'Tasks', 'Features'];
            const data = [typeCounts.bug, typeCounts.task, typeCounts.feature];

            const ctx = document.getElementById('item-type-chart').getContext('2d');
            itemTypeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: data,
                        backgroundColor: ['#EF4444', '#3B82F6', '#10B981'], // Vermelho para bug, azul para task, verde para feature
                        borderColor: ['#B91C1C', '#2563EB', '#059669'],
                        borderWidth: 1,
                        borderRadius: 5,
                        datalabels: {
                            color: '#333',
                            anchor: 'end',
                            align: 'top'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Itens'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Tipo: ${tooltipItems[0].label}`;
                                },
                                label: function(tooltipItem) {
                                    return `Quantidade: ${tooltipItem.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to create the Status by Type Chart
        function createStatusByTypeChart() {
            if (statusByTypeChartInstance) {
                statusByTypeChartInstance.destroy();
            }

            const itemTypes = ['bug', 'task', 'feature'];
            const statuses = ['Produção', 'Pronto pra produção', 'Teste cruzado', 'Desenvolvimento', 'Refinamento', 'Concluído', 'Em Revisão', 'Em Progresso', 'To Do'];
            
            const dataSets = statuses.map(status => {
                const data = itemTypes.map(type => {
                    return sprintItems.filter(item => item.tags.includes(type) && item.status === status).length;
                });
                let color;
                switch(status) {
                    case 'Produção': color = '#A5B4FC'; break;
                    case 'Pronto pra produção': color = '#FCA5A5'; break;
                    case 'Teste cruzado': color = '#6EE7B7'; break;
                    case 'Desenvolvimento': color = '#FDBA74'; break;
                    case 'Refinamento': color = '#E5E7EB'; break;
                    case 'Concluído': color = '#4ADE80'; break;
                    case 'Em Revisão': color = '#A78BFA'; break;
                    case 'Em Progresso': color = '#FACC15'; break;
                    case 'To Do': color = '#60A5FA'; break;
                }
                return {
                    label: status,
                    data: data,
                    backgroundColor: color,
                    datalabels: {
                        color: '#fff',
                        formatter: (value) => value > 0 ? value : ''
                    }
                };
            });

            const ctx = document.getElementById('status-by-type-chart').getContext('2d');
            statusByTypeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Bugs', 'Tasks', 'Features'],
                    datasets: dataSets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Tipo de Item'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Itens'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Tipo: ${tooltipItems[0].label}`;
                                },
                                label: function(tooltipItem) {
                                    return `${tooltipItem.dataset.label}: ${tooltipItem.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to create the Total Items Chart
        function createTotalItemsChart() {
            if (totalItemsChartInstance) {
                totalItemsChartInstance.destroy();
            }

            if (sprintItems.length === 0) {
                document.getElementById('total-items-chart').getContext('2d').clearRect(0, 0, 1, 1);
                return;
            }

            const dates = sprintItems.map(item => item.statusHistory[0].timestamp.getTime()).sort();
            const uniqueDates = [...new Set(dates)].map(date => new Date(date).toLocaleDateString('pt-BR'));
            
            const totalCounts = uniqueDates.map(date => {
                let count = 0;
                sprintItems.forEach(item => {
                    if (new Date(item.statusHistory[0].timestamp).toLocaleDateString('pt-BR') <= date) {
                        count++;
                    }
                });
                return count;
            });

            const ctx = document.getElementById('total-items-chart').getContext('2d');
            totalItemsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: uniqueDates,
                    datasets: [{
                        label: 'Total de Itens',
                        data: totalCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointRadius: 4,
                        tension: 0.3,
                        datalabels: {
                            color: 'rgba(59, 130, 246, 1)',
                            align: 'end',
                            anchor: 'end'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade Total'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Dia: ${tooltipItems[0].label}`;
                                },
                                label: function(tooltipItem) {
                                    return `Total de itens: ${tooltipItem.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to create the Deploy Type Chart
        function createDeployTypeChart() {
            if (deployTypeChartInstance) {
                deployTypeChartInstance.destroy();
            }

            const productionItems = sprintItems.filter(item => item.status === 'Produção');
            const deployCounts = productionItems.reduce((acc, item) => {
                const deployType = item.deployType || 'sem deploy';
                acc[deployType] = (acc[deployType] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(deployCounts);
            const data = Object.values(deployCounts);

            const backgroundColors = labels.map((type) => {
                switch(type) {
                    case 'hotfix': return '#EF4444';
                    case 'release': return '#3B82F6';
                    case 'sem deploy': return '#9CA3AF';
                    default: return '#D1D5DB';
                }
            });

            const ctx = document.getElementById('deploy-type-chart').getContext('2d');
            deployTypeChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tipos de Deploy',
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4,
                        datalabels: {
                            color: '#fff',
                            formatter: (value, ctx) => {
                                const total = ctx.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                const percentage = ((value / total) * 100).toFixed(0);
                                return `${value} (${percentage}%)`;
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(2);
                                    label += ` (${percentage}%)`;
                                    return label;
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const deployType = labels[index];
                            showDeployItemsModal(deployType);
                        }
                    }
                }
            });
        }
        
        // Função para renderizar a tabela na visualização principal (limitada a 3 itens)
        function renderMainTable() {
            const tableBody = document.getElementById('sprint-table-body');
            tableBody.innerHTML = '';
            
            const itemsToShow = sprintItems.slice(0, 3);
            const tableFooter = document.getElementById('table-footer');

            if (sprintItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum item adicionado ainda.</td></tr>`;
                tableFooter.style.display = 'none';
                return;
            }

            itemsToShow.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                let statusColorClass = 'bg-gray-100 text-gray-800';
                switch(item.status) {
                    case 'Produção': statusColorClass = 'bg-indigo-100 text-indigo-800'; break;
                    case 'Pronto pra produção': statusColorClass = 'bg-red-100 text-red-800'; break;
                    case 'Teste cruzado': statusColorClass = 'bg-teal-100 text-teal-800'; break;
                    case 'Desenvolvimento': statusColorClass = 'bg-orange-100 text-orange-800'; break;
                    case 'Refinamento': statusColorClass = 'bg-gray-200 text-gray-800'; break;
                    case 'Concluído': statusColorClass = 'bg-green-100 text-green-800'; break;
                    case 'Em Progresso': statusColorClass = 'bg-yellow-100 text-yellow-800'; break;
                    case 'Em Revisão': statusColorClass = 'bg-purple-100 text-purple-800'; break;
                    case 'To Do': statusColorClass = 'bg-blue-100 text-blue-800'; break;
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${item.tags.map(tag => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${tag}</span>`).join(' ')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <select onchange="changeStatus('${item.id}', this.value)" class="bg-white border border-gray-300 rounded-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Mudar Status</option>
                            <option value="To Do">To Do</option>
                            <option value="Em Progresso">Em Progresso</option>
                            <option value="Em Revisão">Em Revisão</option>
                            <option value="Concluído">Concluído</option>
                            <option value="Produção">Produção</option>
                            <option value="Pronto pra produção">Pronto pra produção</option>
                            <option value="Teste cruzado">Teste cruzado</option>
                            <option value="Desenvolvimento">Desenvolvimento</option>
                            <option value="Refinamento">Refinamento</option>
                        </select>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            tableFooter.style.display = sprintItems.length > 3 ? 'table-row-group' : 'none';
        }
        
        // Função para renderizar a lista completa por semana
        function renderFullList() {
            const fullListContainer = document.getElementById('full-list-container');
            fullListContainer.innerHTML = '';
            
            const sortedItems = [...sprintItems].sort((a, b) => a.statusHistory[0].timestamp - b.statusHistory[0].timestamp);
            const itemsByWeek = sortedItems.reduce((acc, item) => {
                const date = item.statusHistory[0].timestamp;
                const weekStart = new Date(date);
                weekStart.setHours(0, 0, 0, 0);
                weekStart.setDate(date.getDate() - date.getDay());
                
                const weekKey = `Semana de ${weekStart.toLocaleDateString('pt-BR')}`;
                if (!acc[weekKey]) {
                    acc[weekKey] = [];
                }
                acc[weekKey].push(item);
                return acc;
            }, {});

            for (const week in itemsByWeek) {
                const weekSection = document.createElement('div');
                weekSection.className = 'card';
                weekSection.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">${week}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data de Criação</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="week-table-${week.replace(/\s/g, '-')}">
                            </tbody>
                        </table>
                    </div>
                `;
                fullListContainer.appendChild(weekSection);
                
                const tableBody = weekSection.querySelector('tbody');
                itemsByWeek[week].forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${item.tags.map(tag => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${tag}</span>`).join(' ')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                ${item.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${item.statusHistory[0].timestamp.toLocaleDateString('pt-BR')}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        // Função para exibir o modal com a lista de itens
        function showDeployItemsModal(deployType) {
            const modal = document.getElementById('deploy-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalList = document.getElementById('modal-list');

            modalTitle.innerText = `Itens com deploy: ${deployType}`;
            modalList.innerHTML = '';

            const items = sprintItems.filter(item => (item.status === 'Produção' && item.deployType === deployType));
            
            if (items.length > 0) {
                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'border-b border-gray-200 py-2 flex justify-between items-center';
                    
                    const itemName = document.createElement('span');
                    itemName.innerText = item.name;
                    listItem.appendChild(itemName);

                    const itemTags = document.createElement('div');
                    item.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 ml-1';
                        tagSpan.innerText = tag;
                        itemTags.appendChild(tagSpan);
                    });
                    listItem.appendChild(itemTags);
                    
                    modalList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.className = 'text-center text-gray-400 py-4';
                listItem.innerText = 'Nenhum item encontrado.';
                modalList.appendChild(listItem);
            }

            modal.style.display = 'flex';
        }

        // Função para fechar o modal
        function closeModal() {
            const modal = document.getElementById('deploy-modal');
            modal.style.display = 'none';
        }

        // Function to export a single chart to PDF
        function exportChartToPdf(canvasId) {
            const chartCanvas = document.getElementById(canvasId);
            const imgData = chartCanvas.toDataURL('image/png');
            
            // Get the title of the chart
            const chartTitle = chartCanvas.parentElement.querySelector('h3').innerText;
            
            const pdf = new jspdf.jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: 'a4'
            });

            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`${chartTitle.replace(/ /g, '_')}.pdf`);
        }

        // Main function to update the entire UI
        function renderUI() {
            renderMainTable();
            createBurndownChart();
            createCycleTimeChart();
            createStatusDistributionChart();
            createItemTypeChart();
            createStatusByTypeChart();
            createTotalItemsChart();
            createDeployTypeChart();
        }

        // Event listener for form submission
        document.getElementById('item-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('item-name').value;
            const tags = document.getElementById('item-tags').value;
            const status = document.getElementById('item-status').value;
            const deployType = status === 'Produção' ? document.getElementById('deploy-type').value : undefined;

            addItem(name, tags, status, deployType);

            // Reseta o formulário
            this.reset();
        });

        // Initialize on page load
        window.addEventListener('load', () => {
            // Check if there is data in localStorage, if not, save the pre-populated data
            if (!localStorage.getItem('sprintData')) {
                saveData();
            }
            loadData();
            renderUI();
        });
    </script>
</body>
</html>


